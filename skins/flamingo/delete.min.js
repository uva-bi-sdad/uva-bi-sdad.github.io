require.config({paths:{jsTree:"$!services.webjars.url('jstree', 'jstree.min.js')",JobRunner:"$!services.webjars.url('org.xwiki.platform:xwiki-platform-job-webjar', 'jobRunner.min.js')","tree-finder":"$!services.webjars.url('org.xwiki.platform:xwiki-platform-tree-webjar', 'finder.min.js')",tree:"$!services.webjars.url('org.xwiki.platform:xwiki-platform-tree-webjar', 'tree.min.js')"},shim:{jsTree:{deps:["jquery"]}}});require(["jquery","xwiki-meta","tree"],function(a,b){a(document).ready(function(){var g=a("#delete-progress-bar");var c=g.data("job-id");var f=b.restURL.substr(0,b.restURL.indexOf("/rest/"));var e=function(j){g.css("width",j*100+"%");g.data("progress",j)};var i=function(){e(1);a("#delete-progress-bar-container").hide();var j=f+"/rest/joblog/"+c;a.ajax(j,{data:{media:"json",level:"ERROR"}}).done(function(l){if(l.logEvents.length>0){var m="<ul>";for(var k=0;k<l.logEvents.length;++k){m+="<li>"+l.logEvents[k].formattedMessage+"</li>"}m+="</ul>";a("#errorMessage").append(m).removeClass("hidden")}else{a("#successMessage").removeClass("hidden")}})};var d=function(){var j=new XWiki.Document(b.documentReference).getURL("get","xpage=refactoring/delete_question&jobId="+c);a.ajax(j).done(function(n){var k={extensions:[],pages:[],allFreePages:false,allExtensions:false};var l=a("<div>").html(n);a("#delete-progress-bar-container").after(l);a(".deleteTree").xtree({plugins:["checkbox"],core:{themes:{icons:true,dots:true}}});a(".deleteTree").on("changed.jstree",function(o){k.allExtensions=false});a(".btSelectAllTree").click(function(o){o.preventDefault();a(".deleteTree").jstree().check_all();k.allExtensions=true});a(".btUnselectAllTree").click(function(o){o.preventDefault();a(".deleteTree").jstree().uncheck_all()});a(".btConfirmDelete").click(function(q){q.preventDefault();var r=a(".deleteTree").jstree().get_selected(true);k.allFreePages=false;for(var o=0;o<r.length;++o){var p=r[o];if(p.data.type=="extension"){k.extensions.push(p.id)}else{if(p.data.type=="page"){k.pages.push(p.id)}else{if(p.id=="freePages"){k.allFreePages=true}}}}a.ajax(j,{method:"POST",data:{selection:JSON.stringify(k)}}).done(function(){h();l.remove()})});a(".btCancelDelete").click(function(p){p.preventDefault();a(".btConfirmDelete").prop("disabled","disabled");var o=new XWiki.widgets.Notification("$escapetool.javascript($services.localization.render('core.delete.warningExtensions.canceling'))","inprogress");a.ajax(new XWiki.Document(b.documentReference).getURL("get"),{data:{xpage:"refactoring/delete_question",jobId:c,cancel:true}}).done(function(){o.hide();new XWiki.widgets.Notification("$escapetool.javascript($services.localization.render('core.delete.warningExtensions.canceled'))","done");window.location=new XWiki.Document(b.documentReference).getURL()})});var m=(5*60*1000)-(10*1000);setTimeout(function(){a("#delete-progress-bar-container").remove();l.html('<div class="box errormessage"><p>$escapetool.javascript($services.localization.render("core.delete.warningExtensions.timeout"))</p></div>')},m)})};var h=function(){var j=f+"/rest/jobstatus/"+c;a.ajax(j,{data:{media:"json"}}).done(function(k){e(k.progress.offset);if(k.state==="WAITING"){d()}else{if(k.state==="FINISHED"){i()}else{setTimeout(h,1000)}}})};e(g.data("progress"));h()})});